#!/bin/bash
#
# Install node modules if they're out of date.  This looks at a file
# in the node_modules directory to determine if 'yarn install' needs
# to be run.

set -e

UP_TO_DATE=1
YARN_HASH_FILE=node_modules/.yarn.lock.hash

# hash yarn.lock
if [ `uname` = Darwin ]
then
  YARN_LOCK_HASH=`md5 -q yarn.lock`
else
  YARN_LOCK_HASH=`md5sum yarn.lock | cut -d " " -f 1`
fi

# out of date if the hash file is missing
if [ ! -f $YARN_HASH_FILE ]
then
  UP_TO_DATE=0

# out of date if the hash doesn't match
elif [ $YARN_LOCK_HASH != `cat $YARN_HASH_FILE` ]
then
  UP_TO_DATE=0
fi

# run 'yarn install' if needed
if [ $UP_TO_DATE -eq 0 ]
then
  yarn install
  echo $YARN_LOCK_HASH > $YARN_HASH_FILE
fi
